services:
  # ===================================
  # BACKEND TypeScript – Express + Supabase
  # ===================================
  backend:
    build:
      context: ./backend-ts
      dockerfile: Dockerfile
    container_name: siprems-backend-ts
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - ./backend-ts/.env
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ML_SERVICE_URL=http://ml-service:8001
      - PORT=8000
    depends_on:
      - ml-service
    networks:
      - siprems-network
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ===================================
  # ML SERVICE Python – Prophet Models
  # ===================================
  ml-service:
    build:
      context: ./ml-service
      dockerfile: Dockerfile
    container_name: siprems-ml-service
    restart: unless-stopped
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - PORT=8001
    volumes:
      - model_data:/app/models # Model persistence
    networks:
      - siprems-network
    healthcheck:
      test: [ "CMD", "python", "-c", "import requests; requests.get('http://localhost:8001/health')" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # ===================================
  # FRONTEND – React/Vite
  # ===================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      target: development # Change to "production" for production builds
    container_name: siprems-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./src:/app/src
      - ./public:/app/public
      - ./vite.config.ts:/app/vite.config.ts
      - ./index.html:/app/index.html
    environment:
      - VITE_API_BASE_URL=http://localhost:8000/api
    depends_on:
      - backend
    networks:
      - siprems-network

  # ===================================
  # RETRAIN SCHEDULER (Optional)
  # ===================================
  retrain-scheduler:
    build:
      context: ./backend
      dockerfile: Dockerfile.scheduler
    container_name: siprems-retrain-scheduler
    restart: unless-stopped
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - ML_SERVICE_URL=http://ml-service:8001
    depends_on:
      - ml-service
    networks:
      - siprems-network
    profiles:
      - scheduler # Only start with: docker compose --profile scheduler up

# ===================================
# VOLUMES
# ===================================
volumes:
  model_data:
    driver: local

# ===================================
# NETWORKS
# ===================================
networks:
  siprems-network:
    driver: bridge
